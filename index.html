<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>iPlay Store - Painel do Administrador</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Ícones para iOS -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="iPlay Admin">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZPIYOFtfmYEeeHGOCqzHsV1a206n0-cQ",
            authDomain: "iplay-65220.firebaseapp.com",
            projectId: "iplay-65220",
            storageBucket: "iplay-65220.firebasestorage.app",
            messagingSenderId: "264955612573",
            appId: "1:264955612573:web:f5a8b2c548962f6b7d7374",
            measurementId: "G-7MC7673WPH"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const messaging = getMessaging(app);

        // Função para solicitar permissão e registrar token para notificações
        async function requestNotificationPermission() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Permissão para notificações concedida.');
                    const token = await getToken(messaging, { vapidKey: 'SUA_VAPID_KEY_AQUI' }); // Substitua pela sua VAPID Key do Firebase
                    if (token) {
                        console.log('Token FCM:', token);
                        localStorage.setItem('fcmToken', token);
                    } else {
                        console.log('Não foi possível obter o token FCM.');
                    }
                } else {
                    console.log('Permissão para notificações negada.');
                }
            } catch (error) {
                console.error('Erro ao solicitar permissão:', error);
            }
        }

        // Escutar mensagens em foreground
        onMessage(messaging, (payload) => {
            console.log('Mensagem recebida em foreground:', payload);
            new Notification(payload.notification.title, {
                body: payload.notification.body,
                icon: '/icon-512.png'
            });
        });

        // Escutar novos pedidos no Firestore e enviar notificação
        function listenForNewOrders() {
            const pedidosRef = collection(db, "pedidos");
            onSnapshot(pedidosRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const pedido = change.doc.data();
                        console.log('Novo pedido detectado:', pedido);
                        sendNotificationToAdmin(`Novo pedido de ${pedido.nome}`, `Total: R$ ${pedido.total}`);
                    }
                });
            });
        }

        // Função para simular envio de notificação (teste)
        async function sendNotificationToAdmin(title, body) {
            const token = localStorage.getItem('fcmToken');
            if (!token) {
                console.log('Token FCM não encontrado. Solicite permissão primeiro.');
                return;
            }
            console.log('Simulando envio de notificação:', { title, body });
            alert(`Notificação simulada: ${title} - ${body}`);
        }

        async function carregarPedidos() {
            try {
                const querySnapshot = await getDocs(collection(db, "pedidos"));
                const pedidos = [];
                querySnapshot.forEach((doc) => {
                    pedidos.push({ id: doc.id, ...doc.data() });
                });
                return pedidos;
            } catch (e) {
                console.error("Erro ao carregar pedidos: ", e);
                return [];
            }
        }

        async function marcarAtendido(pedidoId) {
            try {
                await updateDoc(doc(db, "pedidos", pedidoId), { status: "atendido" });
                alert("Pedido marcado como atendido!");
            } catch (e) {
                console.error("Erro ao atualizar: ", e);
            }
        }

        window.carregarPedidos = carregarPedidos;
        window.marcarAtendido = marcarAtendido;
        window.requestNotificationPermission = requestNotificationPermission;
        window.sendNotificationToAdmin = sendNotificationToAdmin;
    </script>
    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registrado'))
                    .catch(err => console.log('SW erro:', err));
            });
        }
    </script>
    <style>
        /* ... (CSS igual ao original, mantido intacto) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        :root {
            --bg-body: #0b0c10;
            --bg-card: #1a1c20;
            --bg-elev: #1e2126;
            --accent: #6eea70;
            --text: #ffffff;
            --text-dim: #a1a1a1;
            --border: rgba(255,255,255,0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #08090b;
            color: var(--text);
            min-height: 100vh;
            background-image:
                radial-gradient(circle at 50% 0%, rgba(20,24,30,0.9) 0%, rgba(8,9,11,1) 80%),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm56 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zM50 56c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zM21.955 61c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zM78.045 61c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zM75 39.5c2.485 0 4.5-2.015 4.5-4.5s-2.015-4.5-4.5-4.5-4.5 2.015-4.5 4.5 2.015 4.5 4.5 4.5zM25 39.5c2.485 0 4.5-2.015 4.5-4.5S27.485 30.5 25 30.5s-4.5 2.015-4.5 4.5 2.015 4.5 4.5 4.5zM50 22c2.485 0 4.5-2.015 4.5-4.5S52.485 13 50 13s-4.5 2.015-4.5 4.5S47.515 22 50 22z' fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            background-size: cover, 400px 400px;
        }

        /* ... (restante do CSS igual ao original) */
        /* --- LOGIN SCREEN --- */
        #loginScreen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #08090b; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            padding: 20px;
        }
        .login-box {
            background: var(--bg-card); padding: 30px; border-radius: 16px; border: 1px solid var(--border);
            text-align: center; max-width: 400px; width: 100%;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .login-box h2 { margin-bottom: 20px; color: var(--accent); }
        .login-box input { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; 
            background: #0b0c10; color: #fff; margin-bottom: 15px; font-size: 1rem;
            text-align: center;
        }
        .login-box button { width: 100%; }

        /* --- LAYOUT PRINCIPAL --- */
        #mainContent { display: none; } /* Oculto até logar */

        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(8, 9, 11, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header-container {
            max-width: 1200px; margin: 0 auto; padding: 12px 20px;
            display: flex; align-items: center; gap: 16px; justify-content: space-between;
            flex-wrap: wrap;
        }
        .brand { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 250px; }
        .logo {
            width: 42px; height: 42px; flex-shrink: 0;
        }
        .title { font-weight: 700; font-size: 1.1rem; line-height: 1.2; }
        .hint { color: var(--text-dim); font-size: 0.8rem; margin-top: 2px; }

        .container {
            max-width: 1200px; margin: 20px auto; padding: 0 20px; display: grid; gap: 20px;
            grid-template-columns: 1fr 350px;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 10px 24px rgba(0,0,0,0.3);
        }
        .card h2 {
            font-size: 1.05rem; margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
            color: #fff; font-weight: 700;
        }
        .muted { color: var(--text-dim); font-size: 0.92rem; }

        .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
        button, .btn {
            background: var(--accent); color: #000; border: none; border-radius: 8px;
            padding: 12px 16px; font-weight: 700; cursor: pointer; font-size: 0.9rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            text-decoration: none; transition: 0.2s;
        }
        button:active, .btn:active { transform: scale(0.96); }
        button.secondary { background: #2a2f35; color: #fff; border: 1px solid var(--border); }
        button.danger { background: #ff5555; color: #000; }

        .field { display: grid; gap: 6px; margin-bottom: 12px; }
        .field label { color: #ccc; font-size: 0.85rem; }
        .field input, .field select, .field textarea {
            background: #0b0c10; border: 1px solid #333; color: #fff; border-radius: 8px;
            padding: 12px; font-size: 1rem; width: 100%;
        }
        .two-cols { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
        
        /* PRODUTO ITEM */
        .product-item {
            background: var(--bg-elev);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 14px;
            display: grid; gap: 12px;
        }
        .product-head {
            display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;
        }
        .head-title { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 200px; }
        .head-actions { display: flex; gap: 6px; }
        
        .badge {
            background: rgba(110,234,112,0.15);
            border: 1px solid rgba(110,234,112,0.3);
            color: var(--accent); font-weight: 700; padding: 2px 8px; border-radius: 999px; font-size: 0.75rem;
        }
        
        .product-grid {
            display: grid; gap: 15px; grid-template-columns: 1.5fr 1fr; align-items: start;
        }
        .img-preview { 
            width: 100%; max-width: 200px; height: auto; 
            border-radius: 8px; border: 1px solid #333; background: #fff; padding: 4px; 
            margin-top: 10px;
        }

        .upload-row { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .upload-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; }
        .upload-actions .btn { padding: 8px 12px; font-size: 0.8rem; }

        .aside .card { position: sticky; top: 94px; }
        .small { font-size: 0.8rem; color: #888; margin-top: 5px; line-height: 1.4; }

        .footer-note { text-align: center; color: #555; font-size: 0.8rem; padding: 20px 0 40px; }

        /* --- RESPONSIVIDADE MOBILE --- */
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; padding: 0 15px; margin-top: 15px; }
            .product-grid { grid-template-columns: 1fr; }
            .aside .card { position: static; margin-top: 20px; }
            
            /* Header mais compacto */
            .header-container { padding: 10px 15px; flex-direction: column; align-items: stretch; gap: 12px; }
            .header-container .btn { width: 100%; }
            .title { font-size: 1rem; }
            .hint { display: none; } /* Esconde texto de ajuda no mobile pra economizar espaço */

            /* Botões mais fáceis de tocar */
            .toolbar button, .toolbar label.btn { flex: 1; padding: 14px; text-align: center; }
            .head-actions button { padding: 8px 12px; }
            
            .two-cols { grid-template-columns: 1fr; }
            .upload-actions .btn { width: 100%; }
            .img-preview { max-width: 100%; height: 200px; object-fit: contain; background: #222; }
        }

        /* --- NOVO: SEÇÃO DE PEDIDOS --- */
        .pedido-item {
            background: var(--bg-elev);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 14px;
            display: grid; gap: 12px;
        }
        .pedido-head {
            display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;
        }
        .pedido-info { font-size: 0.9rem; color: var(--text-dim); }
        .pedido-status { 
            padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;
            background: #ff5555; color: #000; 
        }
        .pedido-status.atendido { background: var(--accent); }
    </style>
</head>
<body>

  <!-- TELA DE LOGIN -->
  <div id="loginScreen">
    <div class="login-box">
      <div style="margin: 0 auto 20px; width: 60px; height: 60px; border-radius: 50%; background: radial-gradient(circle, rgba(110,234,112,0.2) 0%, transparent 70%); border: 1px solid var(--accent); display: flex; align-items: center; justify-content: center;">
        <i class="fa-solid fa-lock" style="color: var(--accent); font-size: 24px;"></i>
      </div>
      <h2>Acesso Restrito</h2>
      <input type="password" id="passwordInput" placeholder="Digite a senha de acesso">
      <button onclick="checkLogin()">Entrar</button>
      <p id="loginError" style="color: #ff5555; margin-top: 10px; display: none;">Senha incorreta.</p>
    </div>
  </div>

  <!-- CONTEÚDO DO PAINEL -->
  <div id="mainContent">
    <header>
      <div class="header-container">
        <div class="brand">
          <img class="logo" src="imagem.logo.png" alt="Logo">
          <div>
            <div class="title">IPLAY | Administrador </div>
            <div class="hint">Gerencie produtos e configurações da loja.</div>
          </div>
        </div>
        <a class="btn" href="./index.html" target="_blank" rel="noopener"><i class="fa-solid fa-up-right-from-square"></i> Ver Loja</a>
      </div>
    </header>

    <main class="container">
      <section class="card">
        <h2><i class="fa-solid fa-box"></i> Gerenciar Produtos</h2>
        <div class="toolbar">
          <button id="btnAdd"><i class="fa-solid fa-plus"></i> Adicionar</button>
          <button id="btnSave"><i class="fa-solid fa-floppy-disk"></i> Salvar Tudo</button>
          <button id="btnReset" class="secondary"><i class="fa-solid fa-rotate-left"></i> Resetar</button>
        </div>
        <div id="productsList" class="list"></div>
      </section>

      <aside class="aside">
        <!-- NOVA SEÇÃO: VER PEDIDOS -->
        <section class="card">
          <h2><i class="fa-solid fa-shopping-cart"></i> Ver Pedidos</h2>
          <div class="toolbar">
            <button id="btnLoadPedidos"><i class="fa-solid fa-sync"></i> Carregar Pedidos</button>
          </div>
          <div id="pedidosList"></div>
        </section>

        <section class="card">
          <h2><i class="fa-solid fa-credit-card"></i> Pagamento</h2>
          <div class="field">
            <label for="pix">PIX (Copia e Cola)</label>
            <textarea id="pix" rows="4" placeholder="Cole o código PIX aqui..."></textarea>
          </div>
          <div class="field">
            <label for="credito">Link Cartão de Crédito</label>
            <input id="credito" type="url" placeholder="https://...">
          </div>
          <div class="field">
            <label for="debito">Link Cartão de Débito</label>
            <input id="debito" type="url" placeholder="https://...">
          </div>
        </section>

        <section class="card" style="margin-top:14px;">
          <h2><i class="fa-brands fa-whatsapp"></i> WhatsApp</h2>
          <div class="field">
            <label for="whatsapp">Número (somente números, com DDD)</label>
            <input id="whatsapp" type="tel" placeholder="5599999999999">
          </div>
          <div class="toolbar" style="margin-top:10px">
            <button id="btnSavePay" style="width:100%"><i class="fa-solid fa-floppy-disk"></i> Salvar Configurações</button>
          </div>
        </section>

        <!-- NOVA SEÇÃO: NOTIFICAÇÕES PUSH -->
        <section class="card" style="margin-top:14px;">
          <h2><i class="fa-solid fa-bell"></i> Notificações Push</h2>
          <div class="toolbar">
            <button id="btnRequestPerm"><i class="fa-solid fa-bell"></i> Solicitar Permissão</button>
            <button id="btnTestNotify"><i class="fa-solid fa-paper-plane"></i> Testar Notificação</button>
          </div>
        </section>

        <section class="card" style="margin-top:14px;">
          <h2><i class="fa-solid fa-file-export"></i> Backup</h2>
          <div class="toolbar" style="flex-direction: column;">
            <button id="btnExport" class="secondary" style="width:100%"><i class="fa-solid fa-download"></i> Baixar Backup</button>
            <label class="btn secondary" for="fileImport" style="width:100%; cursor: pointer;">
              <i class="fa-solid fa-upload"></i> Restaurar Backup
              <input id="fileImport" type="file" accept="application/json" style="display:none;">
            </label>
          </div>
          <div class="small" style="text-align: center;">Salva produtos e configs em arquivo JSON.</div>
        </section>
      </aside>
    </main>

    <div class="footer-note">Painel Admin Mobile • iPlay Store</div>
  </div>

  <script>
    // --- LÓGICA DE LOGIN ---
    const SENHA_CORRETA = "IPLAY6202";
    
    function checkLogin() {
      const input = document.getElementById('passwordInput');
      const error = document.getElementById('loginError');
      
      if (input.value === SENHA_CORRETA) {
        sessionStorage.setItem('iplay_auth', 'true');
        showAdmin();
      } else {
        error.style.display = 'block';
        input.value = '';
        input.focus();
      }
    }

    function showAdmin() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }

    // Verifica se já logou nesta sessão
    if (sessionStorage.getItem('iplay_auth') === 'true') {
      showAdmin();
    }

    // Permite dar Enter no campo de senha
    document.getElementById('passwordInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') checkLogin();
    });

    // --- SISTEMA DO ADMIN ---
    const LS_KEYS = { produtos: 'iplay.produtos', pagamento: 'iplay.pagamento' };

    const defaultProdutos = [
      { id: 1, nome: "iPhone 15 Pro Max", cat: "aparelhos", preco: 8299, desc: "1TB Titanium Natural", img: "https://images.unsplash.com/photo-1695822822491-d92cee704368?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.0.3", featured: false },
      { id: 2, nome: "MacBook Pro M3", cat: "aparelhos", preco: 12599, desc: "512GB Space Black", img: "https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=500&q=80", featured: false },
      { id: 3, nome: "MacBook Pro 16\"", cat: "aparelhos", preco: 14999, desc: "1TB Silver M3 Max", img: "https://images.unsplash.com/photo-1611186871348-b1ce696e52c9?auto=format&fit=crop&w=500&q=80", featured: false },
      { id: 4, nome: "AirPods Pro 2", cat: "fones", preco: 1899, desc: "USB-C MagSafe Case", img: "https://images.unsplash.com/photo-1588156979435-379b9d802b74?auto=format&fit=crop&w=400&q=80", featured: false },
      { id: 5, nome: "Apple Watch Ultra 2", cat: "aparelhos", preco: 6299, desc: "Titanium Case 49mm", img: "https://images.unsplash.com/photo-1549439602-43ebca2327af?auto=format&fit=crop&w=400&q=80", featured: false },
      { id: 6, nome: "Carregador MagSafe", cat: "carregadores", preco: 399, desc: "Original Apple 15W", img: "https://images.unsplash.com/photo-1583863788434-e58a36330cf0?auto=format&fit=crop&w=400&q=80", featured: false },
      { id: 7, nome: "Apple Pencil 2", cat: "aparelhos", preco: 899, desc: "Magnética para iPad", img: "https://images.unsplash.com/photo-1557858310-9052820906f7?auto=format&fit=crop&w=400&q=80", featured: false },
      { id: 8, nome: "HomePod Mini", cat: "aparelhos", preco: 799, desc: "Smart Speaker White", img: "https://images.unsplash.com/photo-1596558450255-7c0b7be9d56a?auto=format&fit=crop&w=400&q=80", featured: false }
    ];

    const defaultPagamento = {
      pix: "COLOQUE_AQUI_SEU_PIX_COPIA_E_COLA_OU_LINK",
      credito: "https://SEU-BANCO-OU-GATEWAY.com/link-pagamento-cartao-credito",
      debito: "https://SEU-BANCO-OU-GATEWAY.com/link-pagamento-cartao-debito",
      whatsapp: ""
    };

    let produtos = [];
    let pagamento = {};

    function loadState() {
      try {
        const p = JSON.parse(localStorage.getItem(LS_KEYS.produtos) || 'null');
        const pay = JSON.parse(localStorage.getItem(LS_KEYS.pagamento) || 'null');
        produtos = Array.isArray(p) && p.length ? p : defaultProdutos.slice();
        pagamento = pay && typeof pay === 'object' ? { ...defaultPagamento, ...pay } : { ...defaultPagamento };
      } catch {
        produtos = defaultProdutos.slice();
        pagamento = { ...defaultPagamento };
      }
    }

    function saveProdutosToLS() {
      try {
        localStorage.setItem(LS_KEYS.produtos, JSON.stringify(produtos));
        toast("Produtos salvos!");
      } catch (err) {
        console.error(err);
        alert('Erro ao salvar. Espaço cheio? Tente usar imagens menores.');
      }
    }

    function savePagamentoToLS() {
      try {
        localStorage.setItem(LS_KEYS.pagamento, JSON.stringify(pagamento));
        toast("Configurações salvas!");
      } catch (err) { alert('Erro ao salvar config.'); }
    }

    function toast(msg) {
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); border:1px solid #6eea70; color:#fff; padding:12px 20px; border-radius:30px; z-index:10000;";
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2000);
    }

    function escapeHtml(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function escapeAttr(s) { return String(s || '').replace(/"/g,'&quot;'); }

    // Compressor de imagem
    function fileToDataUrlCompressed(file, maxSize = 800, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const img = new Image();
          img.onload = () => {
            let { width, height } = img;
            const ratio = width / height;
            if (width > height && width > maxSize) { width = maxSize; height = Math.round(maxSize / ratio); }
            else if (height >= width && height > maxSize) { height = maxSize; width = Math.round(maxSize * ratio); }
            const canvas = document.createElement('canvas');
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject;
          img.src = fr.result;
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    const productsListEl = document.getElementById('productsList');

    function newId() { return (produtos.reduce((m, p) => Math.max(m, Number(p.id) || 0), 0) || 0) + 1; }

    function renderProdutosAdmin() {
      productsListEl.innerHTML = '';
      produtos.forEach((p, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'product-item';
        wrap.dataset.index = idx;

        wrap.innerHTML = `
          <div class="product-head">
            <div class="head-title">
              <span class="badge">#${p.id}</span>
              <strong>${escapeHtml(p.nome || 'Sem Nome')}</strong>
            </div>
            <div class="head-actions">
              <button class="secondary" data-action="up"><i class="fa-solid fa-arrow-up"></i></button>
              <button class="secondary" data-action="down"><i class="fa-solid fa-arrow-down"></i></button>
              <button class="secondary" data-action="dup"><i class="fa-solid fa-clone"></i></button>
              <button class="danger" data-action="del"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>

          <div class="product-grid">
            <div>
              <div class="field">
                <label>Nome do Produto</label>
                <input data-field="nome" type="text" value="${escapeAttr(p.nome)}" placeholder="Ex: iPhone 15">
              </div>
              <div class="field">
                <label>Descrição Curta</label>
                <input data-field="desc" type="text" value="${escapeAttr(p.desc || '')}" placeholder="Ex: 128GB Preto">
              </div>
              <div class="two-cols">
                <div class="field">
                  <label>Categoria</label>
                  <select data-field="cat">
                    <option value="aparelhos" ${p.cat === 'aparelhos' ? 'selected' : ''}>Aparelhos</option>
                    <option value="fones" ${p.cat === 'fones' ? 'selected' : ''}>Fones</option>
                    <option value="carregadores" ${p.cat === 'carregadores' ? 'selected' : ''}>Carregadores</option>
                  </select>
                </div>
                <div class="field">
                  <label>Preço</label>
                  <input data-field="preco" type="number" step="1" value="${Number(p.preco)||0}">
                </div>
              </div>
              <div class="field" style="display:flex;align-items:center;gap:10px; margin-top:5px;">
                <input id="feat_${idx}" data-field="featured" type="checkbox" style="width:20px; height:20px;" ${p.featured ? 'checked' : ''}>
                <label for="feat_${idx}" style="font-size:0.95rem; color:#fff;">Destaque (Card Grande)</label>
              </div>
            </div>

            <div>
              <div class="field">
                <label>Imagem</label>
                <div class="upload-row">
                  <input data-field="img" type="url" value="${escapeAttr(p.img || '')}" placeholder="Link da imagem (URL)">
                  <div class="upload-actions">
                    <label class="btn secondary">
                      <i class="fa-solid fa-camera"></i> Enviar Foto
                      <input type="file" accept="image/*" data-role="file" data-index="${idx}" style="display:none;">
                    </label>
                    <button class="secondary" type="button" data-action="clearImg"><i class="fa-solid fa-times"></i></button>
                  </div>
                </div>
              </div>
              <img class="img-preview" src="${escapeAttr(p.img || '')}" alt="preview" ${p.img ? '' : 'style="display:none;"'}/>
            </div>
          </div>
        `;

        // Event Listeners
        wrap.addEventListener('input', onProductFieldChange);
        wrap.addEventListener('change', onProductFieldChange);

        wrap.querySelector('[data-action="del"]').addEventListener('click', () => {
          if (confirm('Deletar?')) { produtos.splice(idx, 1); renderProdutosAdmin(); }
        });
        wrap.querySelector('[data-action="dup"]').addEventListener('click', () => {
          produtos.splice(idx + 1, 0, { ...produtos[idx], id: newId(), nome: (produtos[idx].nome || '') + ' (Cópia)' });
          renderProdutosAdmin();
        });
        wrap.querySelector('[data-action="up"]').addEventListener('click', () => {
          if (idx > 0) { const i = produtos.splice(idx, 1)[0]; produtos.splice(idx - 1, 0, i); renderProdutosAdmin(); }
        });
        wrap.querySelector('[data-action="down"]').addEventListener('click', () => {
          if (idx < produtos.length - 1) { const i = produtos.splice(idx, 1)[0]; produtos.splice(idx + 1, 0, i); renderProdutosAdmin(); }
        });

        // Image Handling
        const fileInput = wrap.querySelector('input[type="file"]');
        const clearBtn = wrap.querySelector('[data-action="clearImg"]');
        const urlInput = wrap.querySelector('input[data-field="img"]');
        const preview = wrap.querySelector('.img-preview');

        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          try {
            const dataUrl = await fileToDataUrlCompressed(file);
            produtos[idx].img = dataUrl;
            urlInput.value = dataUrl;
            preview.src = dataUrl;
            preview.style.display = 'block';
          } catch { alert('Erro na imagem.'); }
          e.target.value = '';
        });

        clearBtn.addEventListener('click', () => {
          produtos[idx].img = '';
          urlInput.value = '';
          preview.src = '';
          preview.style.display = 'none';
        });

        productsListEl.appendChild(wrap);
      });
      
      if(produtos.length === 0) productsListEl.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Sem produtos. Adicione um!</div>';
    }

    function onProductFieldChange(e) {
      const idx = Number(e.target.closest('.product-item').dataset.index);
      const field = e.target.dataset.field;
      if (!field) return;

      let val = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
      if (field === 'preco') val = Number(val) || 0;
      
      produtos[idx][field] = val;

      if (field === 'nome') e.target.closest('.product-item').querySelector('.head-title strong').textContent = val;
      if (field === 'img') {
        const prev = e.target.closest('.product-item').querySelector('.img-preview');
        prev.src = val; prev.style.display = val ? 'block' : 'none';
      }
    }

    // --- NOVO: FUNÇÃO PARA RENDER PEDIDOS ---
    const pedidosListEl = document.getElementById('pedidosList');

    function renderPedidos(pedidos) {
      pedidosListEl.innerHTML = '';
      if (pedidos.length === 0) {
        pedidosListEl.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Nenhum pedido encontrado.</div>';
        return;
      }
      pedidos.forEach((p) => {
        const status = p.status || 'pendente';
        const wrap = document.createElement('div');
        wrap.className = 'pedido-item';

        wrap.innerHTML = `
          <div class="pedido-head">
            <div>
              <strong>${escapeHtml(p.nome || 'Cliente')}</strong>
              <div class="pedido-info">${new Date(p.timestamp?.seconds * 1000 || p.timestamp).toLocaleString('pt-BR')}</div>
            </div>
            <div class="pedido-status ${status}">${status.toUpperCase()}</div>
          </div>
          <div>
            <div><strong>Email:</strong> ${escapeHtml(p.email || '')}</div>
            <div><strong>Telefone:</strong> ${escapeHtml(p.telefone || '')}</div>
            <div><strong>Endereço:</strong> ${escapeHtml(p.endereco || '')}</div>
            <div><strong>Pagamento:</strong> ${escapeHtml(p.pagamento || '')}</div>
            <div><strong>Itens:</strong></div>
            <ul style="margin:5px 0; padding-left:20px;">
              ${p.itens?.map(i => `<li>${i.quantidade}x ${escapeHtml(i.nome)} - R$ ${(i.preco * i.quantidade).toLocaleString('pt-BR')}</li>`).join('') || '<li>Sem itens</li>'}
            </ul>
            <div><strong>Total:</strong> R$ ${(p.total || 0).toLocaleString('pt-BR')}</div>
          </div>
          <div style="margin-top:10px;">
            <button class="secondary" onclick="marcarAtendido('${p.id}')"><i class="fa-solid fa-check"></i> Marcar Atendido</button>
          </div>
        `;

        pedidosListEl.appendChild(wrap);
      });
    }

    // UI Buttons
    document.getElementById('btnAdd').addEventListener('click', () => {
      produtos.push({ id: newId(), nome: 'Novo Item', cat: 'aparelhos', preco: 0, desc: '', img: '', featured: false });
      renderProdutosAdmin();
      // Scroll to bottom
      setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
    });

    document.getElementById('btnSave').addEventListener('click', saveProdutosToLS);
    document.getElementById('btnSavePay').addEventListener('click', () => {
      pagamento.pix = document.getElementById('pix').value;
      pagamento.credito = document.getElementById('credito').value;
      pagamento.debito = document.getElementById('debito').value;
      pagamento.whatsapp = document.getElementById('whatsapp').value.replace(/\D/g,'');
      savePagamentoToLS();
    });

    document.getElementById('btnReset').addEventListener('click', () => {
      if(confirm('Restaurar produtos originais? Você perderá suas alterações.')) {
        produtos = defaultProdutos.slice();
        renderProdutosAdmin();
        saveProdutosToLS();
      }
    });

    // Novo botão para carregar pedidos
    document.getElementById('btnLoadPedidos').addEventListener('click', async () => {
      const pedidos = await carregarPedidos();
      renderPedidos(pedidos);
    });

    // Novo botão para solicitar permissão de notificações
    document.getElementById('btnRequestPerm').addEventListener('click', requestNotificationPermission);

    // Novo botão para testar notificação
    document.getElementById('btnTestNotify').addEventListener('click', () => sendNotificationToAdmin('Teste', 'Notificação de teste enviada!'));

    // Backup
    document.getElementById('btnExport').addEventListener('click', () => {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({produtos, pagamento}));
      const a = document.createElement('a');
      a.href = dataStr; a.download = "backup_loja.json";
      a.click();
    });

    document.getElementById('fileImport').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      try {
        const txt = await file.text();
        const json = JSON.parse(txt);
        if(json.produtos) produtos = json.produtos;
        if(json.pagamento) {
          pagamento = { ...defaultPagamento, ...json.pagamento };
          document.getElementById('pix').value = pagamento.pix || '';
          document.getElementById('credito').value = pagamento.credito || '';
          document.getElementById('debito').value = pagamento.debito || '';
          document.getElementById('whatsapp').value = pagamento.whatsapp || '';
        }
        renderProdutosAdmin();
        saveProdutosToLS();
        savePagamentoToLS();
        alert('Backup restaurado com sucesso!');
      } catch { alert('Arquivo inválido.'); }
      e.target.value = '';
    });

    // Init Logic
    loadState();
    renderProdutosAdmin();
    document.getElementById('pix').value = pagamento.pix || '';
    document.getElementById('credito').value = pagamento.credito || '';
    document.getElementById('debito').value = pagamento.debito || '';
    document.getElementById('whatsapp').value = pagamento.whatsapp || '';

    // Iniciar escuta de pedidos
    listenForNewOrders();
  </script>
</body>
</html>
